worker_processes 1;
pid /tmp/nginx.pid;

events {
  worker_connections 1024;
}

http {
  # Augmenter les limites pour les uploads d'images
  client_max_body_size 5G;     # Taille max des images
  client_body_timeout 300s;     # Timeout upload
  client_header_timeout 60s;

  # Buffers plus larges pour les gros fichiers
  client_body_buffer_size 1m;
  proxy_buffering off;                          # Désactiver le buffering pour les gros fichiers
  proxy_request_buffering off;                  # Stream directement vers Glance

  # Timeouts étendus
  proxy_connect_timeout 60s;
  proxy_send_timeout 300s;
  proxy_read_timeout 300s;

  client_body_temp_path /dev/shm/nginx_client_temp;
  proxy_temp_path /dev/shm/nginx_proxy_temp;
  fastcgi_temp_path /dev/shm/nginx_fastcgi_temp;
  uwsgi_temp_path /dev/shm/nginx_uwsgi_temp;
  scgi_temp_path /dev/shm/nginx_scgi_temp;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  sendfile on;
  keepalive_timeout 65s;
  tcp_nodelay on;

  log_format main '[nginx] method=$request_method path=$request_uri '
                  'status=$status upstream_status=$upstream_status duration=$request_time size=$body_bytes_sent '
                  '"$remote_user" "$http_referer" "$http_user_agent"';

  access_log /dev/stdout  main;

  upstream websocket {
    server 127.0.0.1:9292;
  }

  server {
    server_name image-api.openstack-glance.srv.cluster.local;
    listen 0.0.0.0:8443 ssl;

    client_max_body_size  0;

    ssl_certificate      /etc/ssl/glance-tls-local/certificate;
    ssl_certificate_key  /etc/ssl/glance-tls-local/private_key;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

    location / {
      proxy_pass_request_headers on;

      proxy_http_version  1.1;
      proxy_pass          http://websocket;
      proxy_read_timeout  90;
    }
  }

  server {
    server_name image.low-layer.internal;
    listen 0.0.0.0:8443 ssl;

    client_max_body_size  0;

    ssl_certificate      /etc/ssl/glance-tls-internal/certificate;
    ssl_certificate_key  /etc/ssl/glance-tls-internal/private_key;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;

    location / {
      proxy_pass_request_headers on;

      proxy_http_version  1.1;
      proxy_pass          http://websocket;
      proxy_read_timeout  90;
    }
  }
}